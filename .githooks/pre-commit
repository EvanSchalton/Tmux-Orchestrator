#!/bin/bash
# Pre-commit hook to check if orchestrator context may need updating

# Colors for output
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Path to orchestrator context
ORCHESTRATOR_CONTEXT=".tmux_orchestrator/contexts/orchestrator.md"

# Check if the orchestrator context file exists
if [ ! -f "$ORCHESTRATOR_CONTEXT" ]; then
    echo -e "${YELLOW}Warning: Orchestrator context file not found at $ORCHESTRATOR_CONTEXT${NC}"
    exit 0
fi

# Get the last modified time of the orchestrator context
CONTEXT_MODIFIED=$(git log -1 --format="%at" -- "$ORCHESTRATOR_CONTEXT" 2>/dev/null || echo "0")

# Get list of files being committed (excluding the context file itself)
CHANGED_FILES=$(git diff --cached --name-only | grep -v "$ORCHESTRATOR_CONTEXT")

# Check if any system files have been modified
SYSTEM_FILES_MODIFIED=false
for file in $CHANGED_FILES; do
    if [[ $file == tmux_orchestrator/cli/* ]] || \
       [[ $file == tmux_orchestrator/server/* ]] || \
       [[ $file == tmux_orchestrator/core/* ]] || \
       [[ $file == tmux_orchestrator/utils/* ]] || \
       [[ $file == docs/workflows/* ]] || \
       [[ $file == CLAUDE.md ]] || \
       [[ $file == README.md ]]; then
        SYSTEM_FILES_MODIFIED=true
        break
    fi
done

# If system files were modified, check if context might need updating
if [ "$SYSTEM_FILES_MODIFIED" = true ]; then
    # Check if any of the changed files were modified after the context
    UPDATE_SUGGESTED=false
    
    for file in $CHANGED_FILES; do
        if [ -f "$file" ]; then
            FILE_MODIFIED=$(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file" 2>/dev/null || echo "0")
            if [ "$FILE_MODIFIED" -gt "$CONTEXT_MODIFIED" ]; then
                UPDATE_SUGGESTED=true
                break
            fi
        fi
    done
    
    if [ "$UPDATE_SUGGESTED" = true ]; then
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${YELLOW}⚠️  Orchestrator Context Update Reminder${NC}"
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${YELLOW}System files have been modified. The orchestrator context may need updating.${NC}"
        echo -e "${YELLOW}${NC}"
        echo -e "${YELLOW}Modified system files:${NC}"
        for file in $CHANGED_FILES; do
            if [[ $file == tmux_orchestrator/* ]] || [[ $file == *.md ]]; then
                echo -e "${YELLOW}  - $file${NC}"
            fi
        done
        echo -e "${YELLOW}${NC}"
        echo -e "${YELLOW}Please review: $ORCHESTRATOR_CONTEXT${NC}"
        echo -e "${YELLOW}Update it if CLI commands, workflows, or system behavior has changed.${NC}"
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
    fi
fi

# Always allow the commit to proceed
exit 0